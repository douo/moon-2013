<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>
      dokuwiki新版本&quot;Anteater&quot;支持UTF-8文件名 | 
      DouO's Blog
    </title>
    <meta name="author" content="DouO">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
    
    <!-- Le styles -->
<link href='/moon-2013/assets/stylesheets/bootstrap.min-93b47f97c3444c4711853ed5140d82a1.css' type='text/css' rel='stylesheet' media='all'>
<link href='/moon-2013/assets/stylesheets/bootstrap-responsive.min-6be942c8ec424a44aa4f31e099bae1fc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/moon-2013/assets/stylesheets/toc-24de7073de5e84bbdf82d581655967fa.css' type='text/css' rel='stylesheet' media='all'>
<link href='/moon-2013/assets/stylesheets/style-2a78e0c366d18704c93f8db7772659c6.css' type='text/css' rel='stylesheet' media='all'>
<link href='/moon-2013/assets/stylesheets/widgets/google_prettify/moon-a586c0c53856bb03a2050ca5121629fe.css' type='text/css' rel='stylesheet' media='all'>    

    <!-- script -->
<script src='/moon-2013/assets/javascripts/jquery-1.8.2.min-cfa9051cc0b05eb519f1e16b2a6645d7.js'></script>
<script src='/moon-2013/assets/javascripts/bootstrap.min-240e44e4195f0836ced0eab636f9cb0c.js'></script>
<script src='/moon-2013/assets/javascripts/front-9bcae9460ba6dd25c936b7bdc47a9998.js'></script>
<script src='/moon-2013/assets/javascripts/jquery.c.min-e08fd6c1881afcf509255ce8b8f9b32b.js'></script>
<script src='/moon-2013/assets/javascripts/jquery.smooth-scroll.min-5caac1be39aee89977e39f82d14f0e08.js'></script>    
    
	

<script src="/moon-2013/assets/widgets/lazyload/javascripts/jquery.lazyload.min.js"></script>
    <!-- lazyload -->
    <script type="text/javascript">
      jQuery(document).ready(function($){
      if (navigator.platform == "iPad") return;
      jQuery("img.lazy").not(".cycle img").lazyload({
      effect:"fadeIn",
      placeholder: "/moon-2013/assets/media/ajax-loader.gif"
      });
      });
    </script>
   

    
<!-- Add mousewheel plugin (this is optional) -->
<script type="text/javascript" src="//cdn.staticfile.org/jquery-mousewheel/3.1.3/jquery.mousewheel.min.js"></script>


<!-- Add fancyBox -->
<link rel="stylesheet" href="/moon-2013/assets/widgets/fancybox/stylesheets/jquery.fancybox.css" type="text/css" media="screen" />
<script src="/moon-2013/assets/widgets/fancybox/javascripts/jquery.fancybox.pack.js"></script>

<!-- Optionally add helpers - button, thumbnail and/or media -->

<!-- <link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen" />
<script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-media.js?v=1.0.6"></script>

<link rel="stylesheet" href="/fancybox/source/helpers/jquery.fancybox-thumbs.css?v=1.0.7" type="text/css" media="screen" />
<script type="text/javascript" src="/fancybox/source/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script> -->


<script type="text/javascript">
      $(document).ready(function() {
      $(".fancybox").fancybox();
      });
    </script>
   


    <link rel="shortcut icon" href="/moon-2013/assets/media/favicon.ico">
    <!-- Le fav and touch icons -->
    <!-- Update these with your own images
	 <link rel="shortcut icon" href="images/favicon.ico">
	 <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	 <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	 <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	 -->
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12243999-3']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    <!-- processing -->
    
<script type="text/javascript"
  src="http://cdn.staticfile.org/processing.js/1.4.1/processing.min.js">
</script>

  </head>
  <body>
    <div class="container">
      <div class="row-fluid">
	<div class="span2 hidden-phone"></div>
	<div class="span8">
	  <header class="header pull-left">
	    <h1>dokuwiki新版本&quot;Anteater&quot;支持UTF-8文件名</h1>
	  </header>
  	  <button type="button" class="btn btn-navbar pull-right" data-toggle="collapse" data-target=".nav-collapse">
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	    </button>
	</div> <!-- header -->

         </div>
      <div class="row-fluid">
	<div class="span2 hidden-phone"></div>
	<div class="span8 content">
	  <div class="nav-wrapper nav-collapse collapse"   data-spy="affix" data-offset-top="70" >
	    <nav class="nav moon-nav-list">
	      <ul>
	        <li><a href="/" rel="tooltip" data-placement="top" title="主頁">home</a></li>
	        <li><a href="/moon-2013/archives" rel="tooltip" data-placement="top" title="文章歸檔">archives</a></li>
	        <li><a href="/moon-2013/notes" rel="tooltip" data-placement="top" title="我的個人筆記">notes</a></li>
	        <li><a href="/moon-2013/rss.xml" rel="tooltip" data-placement="top" title="訂閱">feed</a></li>
	        <li><a href="/moon-2013/about" rel="tooltip" data-placement="top" title="關於我">about</a></li>
	        <li  class="separate"></li>
	        <li> 
	  	<a class="meta-nav next" href="/moon-2013/2010/12/30/groovy-introduce">
	  	  <span>←<br></span>Groovy初接触
	  	</a>
	        </li>
	        <li>
	  	<a class="meta-nav previous" href="/moon-2013/2010/12/04/random-words-my-chosen">
	  	  Random Words My Chosen<span><br>→</span>
	  	</a>
	        </li>
	      </ul>
	    </nav>
	  </div>
	  
	      <article class="post box">
<ul class="category-label">
<li><a href="/moon-2013/categories#coder-ref" class="coder">coder</a></li>
</ul>
<div class="cf"></div>


<p>dokuwiki是一款免数据库基于文件的wiki系统，原本其保存文件的命名方式是，对于非ASCII字符的字符用其UTF-8编码按URL编码方式保存。比如一个中文的条目，你看到它保存的文件名可能是
「%E5%A4%9A%E9%87%8D%E5%AF%B9%E6%95%B0%E5%87%BD%E6%95%B0.txt」。
这么一大串实际上只有6个汉字，让人好生不爽呀。</p>

<p>近日整理博客的时候发现，dokuwiki有了新版本「<a href="http://www.splitbrain.org/projects/dokuwiki" title="">Anteater</a>」，立马换上去。而后，在<a href="http://www.easyboxlite.com/index.php?" title="">EasyBoxLite建站</a>的<a href="http://www.easyboxlite.com/index.php?post/2010/11/08/dokuwiki_new_release_2010-11-07_Anteater" title="">dokuwiki新版本发布
- 2010-11-07
「Anteater」</a>上发现，新版的dokuwiki支持用utf-8编码命名文件了，相当给力！这样在FTP上面就可以正确显示出中文文件名，友好多了。在配置管理器页面的<strong>非
ASCII
文件名的编码方法</strong>(<a href="http://www.dokuwiki.org/config:fnencode" title="">fnencode</a>)可以做更改，默认的还是原来URL编码，还一个选项是「安全」，这个没有试验过估计dokuwiki用自己的方式对utf8字符再编码，据说比URL编码更短，比UTF8安全，但人不可读的。这也是在说UTF8编码不是安全的，在一些服务器上面可能不能正常工作，比如说我的Win7——文件名是Unicode-16LE编码的；还有我的SSH服务器（CentOS）——没有中文字符集或者说所有非ASCII字符的会变成问号
:?: ，这些服务器都可能会出问题。</p>

<p>还有一点，将文件名的编码设置成utf-8的格式，那些之前用URL编码保存的文件dokuwiki是不会帮你重命名的，也就说之前的写好的wiki条目都访问不了，是很郁闷的一件事啊！于是乎趁php还未手生写了个批量重命名的php脚本。脚本如下：</p>
<pre><code class="php">&lt;?php 
/*  
*  fixfn.php  
*  !!!注意，转换前千万个一定要备份原数据!!!!  
*  跟要修改的data文件夹放在同目录，一般是dokuwiki的根目录。  
*  也可以放在任意位置，但要自己修改dokuwiki的data文件夹位置,在最下面的$ds变量指定  
*  访问执行一次便可。  
*  对文件名里有&quot;%&quot;符号的文件才会有影响  
*  重复运行虽无影响,但运行完还是删了好  
*  如果文件名中&quot;%&quot;出现在不应该出现的地方,那文件名肯定会错乱滴  
*  !!!注意，转换前千万个一定要备份原数据!!!!  
*/
function simpleHexToNum($s){
    $s=strtoupper($s);
    $x = ord($s);

    if($x&gt;=ord(&quot;0&quot;) &amp;&amp; $x&lt;=ord(&quot;9&quot;)){
       return $x-ord('0');
    }
    if($x&gt;=ord('A')&amp;&amp;$x&lt;=ord('F')){
       return $x-ord('A')+10;
    }
    return -1;
}
function toUTF8($str){  //文件名中百分号(%)后面必须跟着两位16进制数才能正常工作  
    $len = strlen($str);
    $result ='';
    $i=0;
    while($i&lt;$len){
        if($str[$i] == &quot;%&quot;){
            $i++;
            $d = simpleHexToNum($str[$i++])*16+simpleHexToNum($str[$i++]); //DIG
            $result =$result . chr($d);
        }else{
            $result =$result . $str[$i++];
        }

    }
    return $result;
}
function rename_data($path){
        if(is_dir($path)){
                echo $path . &quot;&lt;br /&gt;&quot;;
                $dp=dir($path);
                while($file=$dp-&gt;read())
                        if($file!='.'&amp;&amp;$file!='..'){
                            //  $nfile = toUTF8($file); //亲测可用  
                                $nfile = urldecode($file);   //php自带urldeconde,这个健壮性会好很多吧 ...汗  
                                echo &quot;rename &lt;strong&gt;&quot; . $file.&quot;&lt;/strong&gt; to &lt;strong&gt;&quot; .$nfile . &quot;&lt;/strong&gt;&lt;br /&gt;&quot;;
                                echo  rename($path.&quot;/&quot;.$file , $path.&quot;/&quot;.$nfile)?&quot;&lt;font color=\&quot;#00FF00\&quot;&gt;success&lt;/font&gt;&quot;:&quot;&lt;font color=\&quot;#FF0000\&quot;&gt;fail&lt;/font&gt;&quot; ;
                                echo &quot;&lt;br /&gt;&quot;;
                                rename_data($path.'/'.$nfile);
                        }
                $dp-&gt;close();
        }

}
echo &quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot;&gt;&lt;/head&gt;&quot;;

//可能要动手修改的地方  
$ds =dirname(__FILE__) . &quot;/data&quot;;  //默认同目录下的data文件夹  
//$ds = &quot;/xxxx/dourok.info/wiki/data&quot;;  //自己指定data文件夹  
rename_data($ds); 


echo &quot;&lt;font color=\&quot;#FF0000\&quot;&gt;if everything running fine,delete this php file&lt;/font&gt;&lt;/html&gt;&quot;;
?&gt;
</code></pre>
<p>对跟我一样只有FTP权限的童鞋应该有帮助，将上面的代码复制下来，保存成php文件如fixfn.php，最好UTF8编码的，上传到服务器，位置见代码注释，访问一下搞定。再次提醒一定得<strong>备份原数据</strong>啊！php菜鸟一个，你们懂的。</p>

<p>突然想来一段FML:
今天，本来是想把dokuwiki的老数据拉到本地系统上来改名的，用Java写好了代码才想起windows文件名不是utf-8，于是乎再将数据跟代码传到我的ssh服务器上，上面有java环境，运行下才发现服务器不支持非ASCII字符，我一早知道又给忘了，无奈只能用php重写，实现了url解码成功改完名后，才发现php有urldecode…FML</p>

<div class="footer">
  <ul class="tag_box inline">
  <li><a href="/moon-2013/tags#dokuwiki-ref">dokuwiki</a></li>
  <li><a href="/moon-2013/tags#FML-ref">FML</a></li>
  <li><a href="/moon-2013/tags#php-ref">php</a></li>
  <li><a href="/moon-2013/tags#UTF-8-ref">UTF-8</a></li>
  </ul>
  <span class="date">
  2010-12-09
  </span>
</div>
</article>


<div class="box">
  <div class="plus">
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
<g:plusone></g:plusone>
    <!-- JiaThis Button BEGIN -->
<div class="jiathis_style"><span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_qzone"></a>
<a class="jiathis_button_tsina"></a>
<a class="jiathis_button_tqq"></a>
<a class="jiathis_button_renren"></a>
<a class="jiathis_button_kaixin001"></a>
<a href="http://www.jiathis.com/share?uid=1677096" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	data_track_clickback:true,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1677096" charset="utf-8"></script>
<!-- JiaThis Button END -->
	

  </div>
    <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_developer = 1;
	var disqus_title = 'dokuwiki新版本&quot;Anteater&quot;支持UTF-8文件名';

	var disqus_identifier ='412 http://dourok.info/?p=412';

	var disqus_shortname = 'doousblog';
	
	var disqus_url = 'https://douo.github.io/moon-2013/2010/12/09/dokuwiki-new-realease';
	
	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

<noscript>
	Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<!-- disqus end-->

 </div>

	      </div>  <!-- content -->
      </div>  <!-- row -->
      <div class="row-fluid">
	<div class="span2 hidden-phone"></div>
	<div class="span8">
	  <footer class="statement">
	    <small class＝"copyright">&copy;2009-2013  |</small>
	    <small class= "power">基於 <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
	      和 <a href="http://twitter.github.com/bootstrap/"
	  	  target="_blank">Twitter Bootstrap</a> <a href="/diary"><img src="/moon-2013/assets/media/broken_heart.png"></img></a></small>
	    <small class="license">
	      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" original="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png"></a>		
	    </small>
	  </footer>
	  
	      </div>
      </div>
	
	
<script type="text/javascript">
   $(function(){
   $(window).scroll(function(){  //只要窗口滚动,就触发下面代码 
   var scrollt = document.documentElement.scrollTop + document.body.scrollTop; //获取滚动后的高度 
   if( scrollt >200 ){  //判断滚动后高度超过200px,就显示  
	$("#gotop").fadeIn(400); //淡出     
	}else{      
	$("#gotop").stop().fadeOut(400); //如果返回或者没有超过,就淡入.必须加上stop()停止之前动画,否则会出现闪动   
	}
	});
	$("#gotop").click(function(){ //当点击标签的时候,使用animate在200毫秒的时间内,滚到顶部
	$("html,body").animate({scrollTop:"0px"},200);
	});
	});
</script>
<a id="gotop" href="#">   
	<span>▲</span> 
</a>
    </div> <!-- /container -->
    
    <!-- Google Prettify -->
<script src="http://cdn.staticfile.org/prettify/r298/prettify.min.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
  </body>

</html>
